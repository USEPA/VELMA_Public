<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width">
    <meta name="charset" content="utf-8">
    <link rel="stylesheet" type="text/css" href="public/css/style.css">
    <script src="https://requirejs.org/docs/release/2.3.7/minified/require.js"> </script>
    <script src="public/js/search.js" type="module"> </script>
    <script src="public/js/suggestion.js" type="module"> </script>
    <title> </title>
  </head>
  <body class="bg-primary">
    <div class="header blue-base">
      <nav class="navbar blue-base navbar-expand"><a class="navbar-brand" href="./index.html">VELMA 2.2 HOME</a>
        <ul class="navbar-nav no-bullets">
          <li class="nav-item dropdown">VELMA 2.0 Manual
            <ul class="nav-dropdown blue-light">
              <li class="nav-item"><a class="nav-link" href="./intro.html"><span>I. Intro</span></a></li>
              <li class="nav-item"><a class="nav-link" href="./changes.html"><span>II. Changes from 1.0</span></a></li>
              <li class="nav-item"><a class="nav-link" href="./about.html"><span>III. About</span></a></li>
              <li class="nav-item"><a class="nav-link" href="./input_files.html"><span>IV. Input Files </span></a></li>
              <li class="nav-item"><a class="nav-link" href="./new_sim_config.html"><span>V. Sim Config</span></a></li>
              <li class="nav-item"><a class="nav-link" href="./parameter_config.html"><span>VI. Parameter Config</span></a></li>
            </ul>
          </li>
          <li class="nav-item dropdown">Appendicies
            <ul class="nav-dropdown blue-light">
              <li class="nav-item"><a class="nav-link" href="./appendix_1.html"><span>Overview of VELMA's Leaf-Stem-Root (LSR) Plant Biomass Submodel</span></a></li>
              <li class="nav-item"><a class="nav-link" href="./appendix_2.html"><span>Initializing a Spatial Data Pool Using an ASCII Grid</span></a></li>
              <li class="nav-item"><a class="nav-link" href="./appendix_3.html"><span>Creating Initial ASCII Grid Chemistry Spatial Data Pools</span></a></li>
              <li class="nav-item"><a class="nav-link" href="./appendix_4.html"><span>Overview of VELMA Simulator Output</span></a></li>
              <li class="nav-item"><a class="nav-link" href="./appendix_5.html"><span>Generating daily temperature and precipitation grids for running VELMA</span></a></li>
              <li class="nav-item"><a class="nav-link" href="./appendix_6.html"><span>Hydrological and Biochemical Model Descriptions</span></a></li>
              <li class="nav-item"><a class="nav-link" href="./appendix_7.html"><span>Creating Flat-Processed DEM Data For The VELMA Simulator</span></a></li>
            </ul>
          </li>
          <li class="nav-item dropdown">Supplemental Info (VELMA 2.1)
            <ul class="nav-dropdown blue-light">
              <li class="nav-item"><a class="nav-link" href="./supplement-a1.html"><span>Organic Contaminant Modeling Using VELMA</span></a></li>
              <li class="nav-item"><a class="nav-link" href="./supplement-a2.html"><span>Configure VELMA for Simulating Contaminant Fate and Transport</span></a></li>
              <li class="nav-item"><a class="nav-link" href="./supplement-a3.html"><span>VELMA Contaminant Modeling Demonstration</span></a></li>
              <li class="nav-item"><a class="nav-link" href="./supplement-a4.html"><span>Adding Stormwater Drains for Urban &amp; Mixed-Use Watershed Applications</span></a></li>
              <li class="nav-item"><a class="nav-link" href="./supplement-b1.html"><span>Creating Flat-Processed DEM Data for the VELMA Simulator</span></a></li>
              <li class="nav-item"><a class="nav-link" href="./supplement-b2.html"><span>JPDEM Cell Highlighter</span></a></li>
              <li class="nav-item"><a class="nav-link" href="./supplement-b3.html"><span>JPDEM Flow Accumulation (Facc) Threshold Display</span></a></li>
              <li class="nav-item"><a class="nav-link" href="./supplement-b4.html"><span>JPDEM Flow Test Tool</span></a></li>
              <li class="nav-item"><a class="nav-link" href="./supplement-b5.html"><span>JPDEM Saving Data to Files</span></a></li>
              <li class="nav-item"><a class="nav-link" href="./supplement-b6.html"><span>JPDEM User-Specified Map Borders</span></a></li>
              <li class="nav-item"><a class="nav-link" href="./supplement-b7.html"><span>JPDEM User-Specified Border Mask</span></a></li>
              <li class="nav-item"><a class="nav-link" href="./supplement-b8.html"><span>JPDEM for Viewing Map Differences</span></a></li>
              <li class="nav-item"><a class="nav-link" href="./supplement-b9.html"><span>JPDEM Sub-Reach Delineations</span></a></li>
              <li class="nav-item"><a class="nav-link" href="./supplement-b10.html"><span>Flow Path Modification with the JPDEM Channel Cutter</span></a></li>
              <li class="nav-item"><a class="nav-link" href="./supplement-c1.html"><span>VELMA Reach Mapping</span></a></li>
              <li class="nav-item"><a class="nav-link" href="./supplement-c2.html"><span>How to Run VELMA in Parallel Mode</span></a></li>
              <li class="nav-item"><a class="nav-link" href="./supplement-c3.html"><span>Rationale for Parallel Velma and Reach Segmentation</span></a></li>
              <li class="nav-item"><a class="nav-link" href="./supplement-d1.html"><span>Acquisition &amp; Generation of VELMA Input Data</span></a></li>
              <li class="nav-item"><a class="nav-link" href="./supplement-d2.html"><span>Soil Data Mapping and Parameter Initialization</span></a></li>
              <li class="nav-item"><a class="nav-link" href="./supplement-d3.html"><span>Initialize a Spatial Data Pool Using an Ascii Grid</span></a></li>
              <li class="nav-item"><a class="nav-link" href="./supplement-d4.html"><span>Create Initial Soil and Plant Chemistry Spatial (ASCII Grid) Data Pools</span></a></li>
              <li class="nav-item"><a class="nav-link" href="./supplement-d5.html"><span>Create Land-zoning Maps for a VELMA Application</span></a></li>
              <li class="nav-item"><a class="nav-link" href="./supplement-d6.html"><span>Add Georeferenced Projection Information to VELMA Output ASCII Maps</span></a></li>
              <li class="nav-item"><a class="nav-link" href="./supplement-d7a.html"><span>Create Multiple-Location Weather Drivers</span></a></li>
              <li class="nav-item"><a class="nav-link" href="./supplement-d7b.html"><span>Development of Statistical Models Based on Monthly PRISM / Daymet Data</span></a></li>
              <li class="nav-item"><a class="nav-link" href="./supplement-d8.html"><span>Cell Data Writer Configuration</span></a></li>
              <li class="nav-item"><a class="nav-link" href="./supplement-d9.html"><span>Set Up VELMA biomass Outputs as Inputs to BlueSky</span></a></li>
              <li class="nav-item"><a class="nav-link" href="./supplement-d10.html"><span>Default Tidewater Model Configuration</span></a></li>
              <li class="nav-item"><a class="nav-link" href="./supplement-e1.html"><span>Mapping Surface Layer Permeabilities</span></a></li>
              <li class="nav-item"><a class="nav-link" href="./supplement-e2.html"><span>VELMA Surface Chemistry Pools</span></a></li>
              <li class="nav-item"><a class="nav-link" href="./supplement-e3.html"><span>Deposition of Surface Chemicals</span></a></li>
              <li class="nav-item"><a class="nav-link" href="./supplement-e4.html"><span>Implementing Green Roof Applications</span></a></li>
              <li class="nav-item"><a class="nav-link" href="./supplement-e5.html"><span>Irrigation Disturbance</span></a></li>
              <li class="nav-item"><a class="nav-link" href="./supplement-e6.html"><span>Groundwater Storage Mechanism</span></a></li>
              <li class="nav-item"><a class="nav-link" href="./supplement-e7.html"><span>Spatial Data Writer Key Words for Generating ASCII VELMA Outputs for Data Visualization</span></a></li>
            </ul>
          </li>
          <li class="nav-item dropdown"> <a class="nav-link" href="./dev_info.html"><span>Developer Info</span></a>
            <ul class="nav-dropdown blue-light">
              <li class="nav-item"><a class="nav-link" href="./GetVelma_ForEclipse.html"><span>Clone Github to Local Machine</span></a></li>
              <li class="nav-item"><a class="nav-link" href="./CellSpecificBurnDisturbance_Configuration_Guide.html"><span>Cell Specific Burn Disturbance Config Guide</span></a></li>
              <li class="nav-item"><a class="nav-link" href="./Configuration_Checker_Guide.html"><span>Configuration Checker Guide</span></a></li>
              <li class="nav-item"><a class="nav-link" href="./DefaultSedimentModel_Configuration_Guide.html"><span>Default Sediment Model Config Guide</span></a></li>
              <li class="nav-item"><a class="nav-link" href="./Sediment_Output_Data_Summary.html"><span>Sediment Output Data Summary</span></a></li>
              <li class="nav-item"><a class="nav-link" href="./ForestBurnLsrDisturbanceModel_Overview.html"><span>Forest Burn LSR Disturbance Model</span></a></li>
              <li class="nav-item"><a class="nav-link" href="./JPDEM_ReachMapping_Demonstration.html"><span>JPDEM Reaching Mapping Demo</span></a></li>
              <li class="nav-item"><a class="nav-link" href="./MinMaxAirT_WeatherDrivers.html"><span>Min Max Air Temp Weather Drivers</span></a></li>
              <li class="nav-item"><a class="nav-link" href="./ModifySpatialDataByMap_Guide.html"><span>Modify Spatial Data by Map Guide</span></a></li>
              <li class="nav-item"><a class="nav-link" href="./ObsRunoff_and_NaNs.html"><span>OBS Runnoff and NaNs</span></a></li>
              <li class="nav-item"><a class="nav-link" href="./OrganicContaminant_Overview.html"><span>Organic Contaminant Overview</span></a></li>
              <li class="nav-item"><a class="nav-link" href="./OrganicContaminant_Remediation_Configuration_Guide.html"><span>Organic Contaminant Redemption Config Guide</span></a></li>
              <li class="nav-item"><a class="nav-link" href="./OrganicContaminant_Tracer_Configuration_Guide.html"><span>Organic Contaminant Tracer Config Guide</span></a></li>
              <li class="nav-item"><a class="nav-link" href="./ReachSpecificObservedRunnoff.html"><span>Reach Specific Observed Runnoff</span></a></li>
              <li class="nav-item"><a class="nav-link" href="./SnowDepth_Initialization_Guide.html"><span>Snow Depth Initialization Guide</span></a></li>
              <li class="nav-item"><a class="nav-link" href="./TopoFiles_Output_Summary.html"><span>Topo Files Output Summary </span></a></li>
              <li class="nav-item"><a class="nav-link" href="./VelmaParallel_Error_Reports.html"><span>Velma Parallel Error Reports</span></a></li>
              <li class="nav-item"><a class="nav-link" href="./VelmaParallel_With_Multiple_Maps.html"><span>Velma Parallel With Multiple Maps </span></a></li>
              <li class="nav-item"><a class="nav-link" href="./WaterDrainDisturbanceModel_Overview.html"><span>Water Drain Disturbance Model</span></a></li>
              <li class="nav-item"><a class="nav-link" href="./VelmaSimulatorCmdLine_Overview.html"><span>Velma Sim Cmd Line Guide</span></a></li>
              <li class="nav-item"><a class="nav-link" href="./VelmaSimulatorAltCmdLine_Overview.html"><span>Velma Sim Alt Cmd Line Guide</span></a></li>
              <li class="nav-item"><a class="nav-link" href="./SurfaceEvaporation_Overview.html"><span>Surface Evaporation Overview</span></a></li>
            </ul>
          </li>
          <li class="nav-item dropdown"> <a class="nav-link" href="./dev_utils.html"><span>Developer Utils</span></a>
            <ul class="nav-dropdown blue-light">
              <li class="nav-item"><a class="nav-link" href="./AscMapOct_Guide.html"><span>Ascii Map Oct Guide </span></a></li>
              <li class="nav-item"><a class="nav-link" href="./AscRangeMask_Guide.html"><span>Ascii Range Mask Guide</span></a></li>
              <li class="nav-item"><a class="nav-link" href="./MoeVelGenerator_Guide.html"><span>MOEA-to-VELMA Configuration Generator</span></a></li>
              <li class="nav-item"><a class="nav-link" href="./NashSutcliffeCalculator_Guide.html"><span>Tool for Computing Nash-Sutcliffe Coefficients</span></a></li>
              <li class="nav-item"><a class="nav-link" href="./NseQuarts_Guide.html"><span>NseQuarts Guide</span></a></li>
              <li class="nav-item"><a class="nav-link" href="./VelmaSimRunner_QuickRef.html"><span>VelmaSimRunner Quick Reference</span></a></li>
              <li class="nav-item"><a class="nav-link" href="./VelmaSimRunner.html"><span>VelmaSimRunner Full Guide</span></a></li>
            </ul>
          </li>
        </ul>
      </nav>
    </div>
    <div class="modal" id="suggestionModal">
      <div class="modal-content"> <span class="close">&times;</span>
        <h2>Submit a Suggestion </h2>
        <form id="suggestionForm"> 
          <textarea class="suggestion_textbox" id="suggestionText" name="suggestionText" require="True" placeholder="Enter your suggestion here ..."> </textarea>
          <button class="submit_btn" type="submit">Submit</button>
        </form>
      </div>
    </div>
    <div class="main_body container" id="main_body">
      <div class="plus-sign">
        <p>+</p>
      </div>
      <h1>B.7 | JPDEM User-Specified Border Mask</h1>
      <div class="info blue-light-1"> 
        <p>Overview <i>(Tutorial B.7 - JPDEM User-Specified Border Masks)</i></p>
        <p>This JPDEM tutorial (B.7) builds on Tutorial B.6, "JPDEM User-Specified Map Borders", specifically to provide a more detailed example of how to create a DEM border mask that encompasses large waterbodies at the edge of the DEM. By including these flat features as part of the map border, JPDEM will ignore them during flat-processing of raw DEM maps, considerably speeding up the flat- processing process.</p>
      </div>
      <h3>Example</h3>
      <p>This is an example of how to flat-process a large DEM grid in JPDEM in a reasonable amount of time, by</p>
      <p>taking advantage of JDPEM's user-specifiable border-mask functionality.</p>
      <p>We start with the original "raw" DEM ASCII grid (.asc) file we wish to flat process:</p><code>thornton_mask_v2_10m.asc</code>
      <p>The header information for this file is:</p>
      <table>
        <tr>
          <td>ncols</td>
          <td>681</td>
        </tr>
        <tr>
          <td>nrows</td>
          <td>990</td>
        </tr>
        <tr>
          <td>xllcorner</td>
          <td>548019.221</td>
        </tr>
        <tr>
          <td>yllcorner</td>
          <td>5281283.0124</td>
        </tr>
        <tr>
          <td>cellsize</td>
          <td>10</td>
        </tr>
        <tr>
          <td>NODATA_value</td>
          <td>-9999</td>
        </tr>
      </table>
      <p>Initial efforts to flat-process this grid with JPDEM's Standard (STD) and Alternate (ALT) flat-processing algorithms failed.</p>
      <p>The grid is large enough, and has enough "flat spots" that these algorithms reach hard-wired, "unable to complete" timeout limits before all flat areas have been processed.</p>
      <p>Attempts to flat-process this grid with the Experimental (EXP) and Enhanced Experimental (EEX) algorithms likewise failed. Unlike the STD and ALT algorithms, EXP and EEX do not have mandatory timeout limits, but neither algorithm was able to complete the flat-processing task after running continuously for more than 35 days.</p>
      <p>Here is a screen-capture of the raw DEM file, loaded into JPDEM, with cells that have value == 0.0</p>
      <p>highlighted in "<span color='pink'>pepto-pink</span>":</p><img width="549" height="750" alt="screenshot" title="screenshot" src="public/suppImage_123.jpg">
      <p>The highlighted, "all cells are zero" area on the right side of the raw DEM has a drastic impact on all the flat-processing algorithms, but because that area of uniform-value cells lies against an edge of the grid,</p>
      <p>the EXP and EEX algorithms in particular spend an inordinate amount of their processing time ensuring flow through that area and to the grid edge.</p>
      <p>We can tell JPDEM to ignore the problem "all cells are zero" area by providing it with a border mask map that marks all the zero value cells as part of "off-limits" border of the grid. JPDEM <i>always </i>requires a border for flat-processing, and only flat-processes cells that lie within the border ("interior cells").</p>
      <p>Loading an .asc file into JPDEM "as DEM" automatically designates the top and bottom rows, and the left and right-most columns of cells as the border. However, when an .asc file is loaded into JPDEM "raw", no border is created, and the "Load Border Mask" menu item can subsequently be used to specify an arbitrary border that is applied to the raw-loaded DEM values.</p>
      <p>A border mask .asc file's grid values must be either "0" (for border cells) or "1" for (interior cells). The values must also be integers (i.e. "0.0" or "1.0" is not allowed).</p>
      <p>A border mask must always include the default border as border cells; i.e. the top and bottom rows and left-most and right-most columns must be marked as border cells.</p>
      <p>GIS tools like ArcMap can be used to create border mask .asc files of arbitrary complexity and detail, but for the thornton_mask_v2_10m.asc file, we can take advantage of the fact that the border we wish to create is either a cell in the top or bottom row, left or right-most column OR has a cell value of "0.0".</p>
      <p>We can encode this relatively simple set of rules into a small Awk script and run it in a Cygwin Bash command shell. A Python script would work as well, and we could run that under a DOS command prompt or Windows PowerShell console, but the Awk code is more succinct.</p>
      <p>Note that the Awk script developed in this example is not a general-purpose script; it takes advantages of various specifics of the thornton_mask_v2_10m.asc file's contents.</p>
      <p>Here is the Awk script in its entirety:</p><code>
        # TOP of MaskMaker.awk 
        BEGIN {
            IGNORECASE = 1;
            headRows = 6;
        }
        # get the number of data rows from the header information
        /^nrows/ {
            dataRows = $2;
        }
        NR <= headRows {
            print;
        }
        # handle data rows, transforming and emitting them on-the-fly
        NR > headRows {
            if (NR == (headRows + 1) || (NR - headRows) == dataRows) {
                for (i=1; i<=NF; ++i) {
                    printf("%s%s",(i==1?"":" "),"0");
                }
                printf("\n");
            } else {
                for (i=1; i<=NF; ++i) {
                    s = "0";
                    if (i > 1 && i < NF) s = $i == 0 ? "0" : "1";
                    printf("%s%s",(i==1?"":" "),s);
                }
                printf("\n");
            }
        }
        # BOT of MaskMaker.awk
        </code>
      <p>We can generate a border mask .asc file for the thornton_mask_v2_10m.asc file by running the following command line in a Cygwin Bash console:</p><code>$ awk -f MaskMaker.awk thornton_mask_v2_10m.asc &gt; thornton_borderMask_v2_10m.asc</code>
      <p>Depending upon the mode of the Cygwin Base console, we may also need to translate the newline characters of the resulting mask file to run under Windows:</p><code>$ unix2dos thornton_borderMask_v2_10m.asc</code><code>unix2dos: converting file thornton_borderMask_v2_10m.asc to DOS format...</code>
      <p>Here's the resulting thornton_borderMask_v2_10m.asc file, "as Raw Map File" into JPDEM. Red</p>
      <p>(interior) cells have value 1, and black (border) cells have value 0:</p><img width="545" height="750" alt="screenshot" title="screenshot" src="public/suppImage_124.jpg">
      <p>Now that we have a raw DEM map, and a border mask to overlay onto it, it's simply a matter ofâ€¦</p>
      <p>Loading the DEM file "<b>as Raw Map File</b>" data . . .</p><img width="576" height="175" alt="screenshot" title="screenshot" src="public/suppImage_125.jpg">
      <p>Loading the border mask file as "<b>Border Mask</b>" data . . .</p><img width="576" height="176" alt="screenshot" title="screenshot" src="public/suppImage_126.jpg">
      <p>and finally, running a flat-processing algorithm on the combined DEM + custom border.</p>
      <p>The STD and ALT flat-processors are <i>not </i>recommended for custom-border situations. Instead, the best bet is the EEX flat-processor (the EXP <i>may </i>work, but is not ideal) . . .</p><img width="572" height="197" alt="screenshot" title="screenshot" src="public/suppImage_127.jpg">
      <p>Here is the EEX flat-processed map, showing the completion message:</p><img width="572" height="787" alt="screenshot" title="screenshot" src="public/suppImage_128.jpg">
      <p>Here are the console messages from the sequence of steps: Load/raw, Load/border, EEX:</p><p>LoadPropertyFilesAction: file=&quot;D:\Users\kdjang\Velma_SiteData\WA_ThorntonCreek\thornton_mask_v2_10m.asc&quot;
<p>hasData=true ncol=681 nrow=990 xll=548019.221 yll=5281283.0124 isLlCenter=false cell=10.0 ndata=-9999.0 zmin=0.0 zmax=167.9841 delx=0 dely=0 minLogFacc=0.0 maxLogFacc=0.0
<p>LoadDmMaskFileAction: file=&quot;D:\Users\kdjang\Velma_SiteData\WA_ThorntonCreek\thornton_borderMask_v2_10m.asc&quot;
<p>At 2017-05-10 15:02:22: Launching Enhanced Experimental Flat-Processor thread ... Experimental Flat-Processor: processed 622821 cells
<p>Experimental Flat-Processor: largest set processed = 4234 Internal Data State Report
<p>Map Summary: Total Cols=681 Total Rows=990 Total Cells=674190 NoData cells: Actual=0
<p>Buffer Cells: Expected=3338 Actual=51369 Suspect=0 !!! WARNING !!! Interior Cells: Expected=670852 Actual=622821 Suspect=0 !!! WARNING !!! At 2017-05-10 15:02:22: STARTED Enhanced Experimental Flat-Processor At 2017-05-10 15:11:45:  DONE Enhanced Experimental Flat-Processor Elapse Time in seconds = 562.374
      <p>Some observations:</p><img height="725" alt="screenshot" title="screenshot" src="public/suppImage_129.jpg">
    </div>
  </body>
  <footer id="footer">
    <p>VELMA 2.2 DOCUMENTATION</p>
  </footer>
</html>