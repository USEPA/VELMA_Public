<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"><meta name="charset" content="utf-8"><link rel="stylesheet" type="text/css" href="/style.css"><title> </title></head><body class="bg-primary"><div class="header blue-base"><nav class="navbar blue-base navbar-expand"><a class="navbar-brand" href="/index.html">VELMA 2.2 HOME</a><ul class="navbar-nav no-bullets"><li class="nav-item"><a class="nav-link" href="/intro.html"><span>I. Intro</span></a></li><li class="nav-item"><a class="nav-link" href="/changes.html"><span>II. Changes from 1.0</span></a></li><li class="nav-item"><a class="nav-link" href="/about.html"><span>III. About</span></a></li><li class="nav-item"><a class="nav-link" href="/input_files.html"><span>IV. Input Files </span></a></li><li class="nav-item"><a class="nav-link" href="/new_sim_config.html"><span>V. Sim Config</span></a></li><li class="nav-item"><a class="nav-link" href="/parameter_config.html"><span>VI. Parameter Config</span></a></li><li class="nav-item dropdown">Appendicies<ul class="nav-dropdown blue-light"><li class="nav-item"><a class="nav-link" href="/appendix_1.html"><span>Appendix 1</span></a></li><li class="nav-item"><a class="nav-link" href="/appendix_2.html"><span>Appendix 2</span></a></li><li class="nav-item"><a class="nav-link" href="/appendix_3.html"><span>Appendix 3</span></a></li><li class="nav-item"><a class="nav-link" href="/appendix_4.html"><span>Appendix 4</span></a></li><li class="nav-item"><a class="nav-link" href="/appendix_5.html"><span>Appendix 5</span></a></li><li class="nav-item"><a class="nav-link" href="/appendix_6.html"><span>Appendix 6</span></a></li><li class="nav-item"><a class="nav-link" href="/appendix_7.html"><span>Appendix 7</span></a></li></ul></li><li class="nav-item dropdown">Supplemental <ul class="nav-dropdown blue-light"><li class="nav-item"><a class="nav-link" href="/supplement-a1.html"><span>Supplement A1</span></a></li><li class="nav-item"><a class="nav-link" href="/supplement-a2.html"><span>Supplement A2</span></a></li><li class="nav-item"><a class="nav-link" href="/supplement-a3.html"><span>Supplement A3</span></a></li><li class="nav-item"><a class="nav-link" href="/supplement-a4.html"><span>Supplement A4</span></a></li><li class="nav-item"><a class="nav-link" href="/supplement-b1.html"><span>Supplement B1</span></a></li><li class="nav-item"><a class="nav-link" href="/supplement-b2.html"><span>Supplement B2</span></a></li><li class="nav-item"><a class="nav-link" href="/supplement-b3.html"><span>Supplement B3</span></a></li><li class="nav-item"><a class="nav-link" href="/supplement-b4.html"><span>Supplement B4</span></a></li><li class="nav-item"><a class="nav-link" href="/supplement-b5.html"><span>Supplement B5</span></a></li><li class="nav-item"><a class="nav-link" href="/supplement-b6.html"><span>Supplement B6</span></a></li><li class="nav-item"><a class="nav-link" href="/supplement-b7.html"><span>Supplement B7</span></a></li><li class="nav-item"><a class="nav-link" href="/supplement-b8.html"><span>Supplement B8</span></a></li><li class="nav-item"><a class="nav-link" href="/supplement-b9.html"><span>Supplement B9</span></a></li><li class="nav-item"><a class="nav-link" href="/supplement-b10.html"><span>Supplement B10</span></a></li><li class="nav-item"><a class="nav-link" href="/supplement-c1.html"><span>Supplement C1</span></a></li><li class="nav-item"><a class="nav-link" href="/supplement-c2.html"><span>Supplement C2</span></a></li><li class="nav-item"><a class="nav-link" href="/supplement-c3.html"><span>Supplement C3</span></a></li><li class="nav-item"><a class="nav-link" href="/supplement-d1.html"><span>Supplement D1</span></a></li><li class="nav-item"><a class="nav-link" href="/supplement-d2.html"><span>Supplement D2</span></a></li><li class="nav-item"><a class="nav-link" href="/supplement-d3.html"><span>Supplement D3</span></a></li><li class="nav-item"><a class="nav-link" href="/supplement-d4.html"><span>Supplement D4</span></a></li><li class="nav-item"><a class="nav-link" href="/supplement-d5.html"><span>Supplement D5</span></a></li><li class="nav-item"><a class="nav-link" href="/supplement-d6.html"><span>Supplement D6</span></a></li><li class="nav-item"><a class="nav-link" href="/supplement-d7a.html"><span>Supplement D7a</span></a></li><li class="nav-item"><a class="nav-link" href="/supplement-d7b.html"><span>Supplement D7b</span></a></li><li class="nav-item"><a class="nav-link" href="/supplement-d8.html"><span>Supplement D8</span></a></li><li class="nav-item"><a class="nav-link" href="/supplement-d9.html"><span>Supplement D9</span></a></li><li class="nav-item"><a class="nav-link" href="/supplement-d10.html"><span>Supplement D10</span></a></li></ul></li><li class="nav-item dropdown"> <a class="nav-link" href="/dev_info.html"><span>Developer Info</span></a><ul class="nav-dropdown blue-light"><li class="nav-item"><a class="nav-link" href="/GetVelma_ForEclipse.html"><span>Clone Github to Local Machine</span></a></li><li class="nav-item"><a class="nav-link" href="/CellSpecificBurnDisturbance_Configuration_Guide.html"><span>Cell Specific Burn Disturbance Config Guide</span></a></li><li class="nav-item"><a class="nav-link" href="/Configuration_Checker_Guide.html"><span>Configuration Checker Guide</span></a></li><li class="nav-item"><a class="nav-link" href="/DefaultSedimentModel_Configuration_Guide.html"><span>Default Sediment Model Config Guide</span></a></li><li class="nav-item"><a class="nav-link" href="/ForestBurnLsrDisturbanceModel_Overview.html"><span>Forest Burn LSR Disturbance Model</span></a></li><li class="nav-item"><a class="nav-link" href="/JPDEM_ReachMapping_Demonstration.html"><span>JPDEM Reaching Mapping Demo</span></a></li><li class="nav-item"><a class="nav-link" href="/MinMaxAirT_WeatherDrivers.html"><span>Min Max Air Temp Weather Drivers</span></a></li><li class="nav-item"><a class="nav-link" href="/ModifySpatialDataByMap_Guide.html"><span>Modify Spatial Data by Map Guide</span></a></li><li class="nav-item"><a class="nav-link" href="/ObsRunoff_and_NaNs.html"><span>OBS Runnoff and NaNs</span></a></li><li class="nav-item"><a class="nav-link" href="/OrganicContaminant_Overview.html"><span>Organic Contaminant Overview</span></a></li><li class="nav-item"><a class="nav-link" href="/OrganicContaminant_Remediation_Configuration_Guide.html"><span>Organic Contaminant Redemption Config Guide</span></a></li><li class="nav-item"><a class="nav-link" href="/OrganicContaminant_Tracer_Configuration_Guide.html"><span>Organic Contaminant Tracter Config Guide</span></a></li><li class="nav-item"><a class="nav-link" href="/ReachSpecificObservedRunnoff.html"><span>Reach Specific Observed Runnoff</span></a></li><li class="nav-item"><a class="nav-link" href="/Sediment_Output_Data_Summary.html"><span>Sediment Output Data Summary</span></a></li><li class="nav-item"><a class="nav-link" href="/SnowDepth_Initialization_Guide.html"><span>Snow Depth Initialization Guide</span></a></li></ul></li><li class="nav-item dropdown"> <a class="nav-link" href="/dev_utils.html"><span>Developer Utils</span></a><ul class="nav-dropdown blue-light"><li class="nav-item"><a class="nav-link" href="/AscMapOct_Guide.html"><span>Ascii Map Oct Guide </span></a></li><li class="nav-item"><a class="nav-link" href="/AscRangeMask_Guide.html"><span>Ascii Range Mask Guide</span></a></li><li class="nav-item"><a class="nav-link" href="/MoeVelGenerator_Guide.html"><span>MOEA-to-VELMA Configuration Generator</span></a></li><li class="nav-item"><a class="nav-link" href="/NashSutcliffeCalculator_Guide.html"><span>Tool for Computing Nash-Sutcliffe Coefficients</span></a></li><li class="nav-item"><a class="nav-link" href="/NseQuarts_Guide.html"><span>NseQuarts Guide</span></a></li><li class="nav-item"><a class="nav-link" href="/VelmaSimRunner_QuickRef.html"><span>VelmaSimRunner Quick Reference</span></a></li><li class="nav-item"><a class="nav-link" href="/VelmaSimRunner.html"><span>VelmaSimRunner Full Guide</span></a></li></ul></li></ul></nav></div><div class="main_body container"><h1>B.7 | JPDEM User-Specified Border Mask</h1><div class="info blue-light-1"> <p>Overview <i>(Tutorial B.7 - JPDEM User-Specified Border Masks)</i></p><p>This JPDEM tutorial (B.7) builds on Tutorial B.6, "JPDEM User-Specified Map Borders", specifically to provide a more detailed example of how to create a DEM border mask that encompasses large waterbodies at the edge of the DEM. By including these flat features as part of the map border, JPDEM will ignore them during flat-processing of raw DEM maps, considerably speeding up the flat- processing process.</p></div><h3>Example</h3><p>This is an example of how to flat-process a large DEM grid in JPDEM in a reasonable amount of time, by</p><p>taking advantage of JDPEM's user-specifiable border-mask functionality.</p><p>We start with the original "raw" DEM ASCII grid (.asc) file we wish to flat process:</p><code>thornton_mask_v2_10m.asc</code><p>The header information for this file is:</p><table><tr><td>ncols</td><td>681</td></tr><tr><td>nrows</td><td>990</td></tr><tr><td>xllcorner</td><td>548019.221</td></tr><tr><td>yllcorner</td><td>5281283.0124</td></tr><tr><td>cellsize</td><td>10</td></tr><tr><td>NODATA_value</td><td>-9999</td></tr></table><p>Initial efforts to flat-process this grid with JPDEM's Standard (STD) and Alternate (ALT) flat-processing algorithms failed.</p><p>The grid is large enough, and has enough "flat spots" that these algorithms reach hard-wired, "unable to complete" timeout limits before all flat areas have been processed.</p><p>Attempts to flat-process this grid with the Experimental (EXP) and Enhanced Experimental (EEX) algorithms likewise failed. Unlike the STD and ALT algorithms, EXP and EEX do not have mandatory timeout limits, but neither algorithm was able to complete the flat-processing task after running continuously for more than 35 days.</p><p>Here is a screen-capture of the raw DEM file, loaded into JPDEM, with cells that have value == 0.0</p><p>highlighted in "<span color='pink'>pepto-pink</span>":</p><img width="549" height="750" alt="screenshot" title="screenshot" src="public/suppImage_123.jpg"><p>The highlighted, "all cells are zero" area on the right side of the raw DEM has a drastic impact on all the flat-processing algorithms, but because that area of uniform-value cells lies against an edge of the grid,</p><p>the EXP and EEX algorithms in particular spend an inordinate amount of their processing time ensuring flow through that area and to the grid edge.</p><p>We can tell JPDEM to ignore the problem "all cells are zero" area by providing it with a border mask map that marks all the zero value cells as part of "off-limits" border of the grid. JPDEM <i>always </i>requires a border for flat-processing, and only flat-processes cells that lie within the border ("interior cells").</p><p>Loading an .asc file into JPDEM "as DEM" automatically designates the top and bottom rows, and the left and right-most columns of cells as the border. However, when an .asc file is loaded into JPDEM "raw", no border is created, and the "Load Border Mask" menu item can subsequently be used to specify an arbitrary border that is applied to the raw-loaded DEM values.</p><p>A border mask .asc file's grid values must be either "0" (for border cells) or "1" for (interior cells). The values must also be integers (i.e. "0.0" or "1.0" is not allowed).</p><p>A border mask must always include the default border as border cells; i.e. the top and bottom rows and left-most and right-most columns must be marked as border cells.</p><p>GIS tools like ArcMap can be used to create border mask .asc files of arbitrary complexity and detail, but for the thornton_mask_v2_10m.asc file, we can take advantage of the fact that the border we wish to create is either a cell in the top or bottom row, left or right-most column OR has a cell value of "0.0".</p><p>We can encode this relatively simple set of rules into a small Awk script and run it in a Cygwin Bash command shell. A Python script would work as well, and we could run that under a DOS command prompt or Windows PowerShell console, but the Awk code is more succinct.</p><p>Note that the Awk script developed in this example is not a general-purpose script; it takes advantages of various specifics of the thornton_mask_v2_10m.asc file's contents.</p><p>Here is the Awk script in its entirety:</p><code># TOP of MaskMaker.awk 
BEGIN {
    IGNORECASE = 1;
    headRows = 6;
}
# get the number of data rows from the header information
/^nrows/ {
    dataRows = $2;
}
NR <= headRows {
    print;
}
# handle data rows, transforming and emitting them on-the-fly
NR > headRows {
    if (NR == (headRows + 1) || (NR - headRows) == dataRows) {
        for (i=1; i<=NF; ++i) {
            printf("%s%s",(i==1?"":" "),"0");
        }
        printf("\n");
    } else {
        for (i=1; i<=NF; ++i) {
            s = "0";
            if (i > 1 && i < NF) s = $i == 0 ? "0" : "1";
            printf("%s%s",(i==1?"":" "),s);
        }
        printf("\n");
    }
}
# BOT of MaskMaker.awk
</code><p>We can generate a border mask .asc file for the thornton_mask_v2_10m.asc file by running the following command line in a Cygwin Bash console:</p><code>$ awk -f MaskMaker.awk thornton_mask_v2_10m.asc &gt; thornton_borderMask_v2_10m.asc</code><p>Depending upon the mode of the Cygwin Base console, we may also need to translate the newline characters of the resulting mask file to run under Windows:</p><code>$ unix2dos thornton_borderMask_v2_10m.asc</code><code>unix2dos: converting file thornton_borderMask_v2_10m.asc to DOS format...</code><p>Here's the resulting thornton_borderMask_v2_10m.asc file, "as Raw Map File" into JPDEM. Red</p><p>(interior) cells have value 1, and black (border) cells have value 0:</p><img width="545" height="750" alt="screenshot" title="screenshot" src="public/suppImage_124.jpg"><p>Now that we have a raw DEM map, and a border mask to overlay onto it, it's simply a matter ofâ€¦</p><p>Loading the DEM file "<b>as Raw Map File</b>" data . . .</p><img width="576" height="175" alt="screenshot" title="screenshot" src="public/suppImage_125.jpg"><p>Loading the border mask file as "<b>Border Mask</b>" data . . .</p><img width="576" height="176" alt="screenshot" title="screenshot" src="public/suppImage_126.jpg"><p>and finally, running a flat-processing algorithm on the combined DEM + custom border.</p><p>The STD and ALT flat-processors are <i>not </i>recommended for custom-border situations. Instead, the best bet is the EEX flat-processor (the EXP <i>may </i>work, but is not ideal) . . .</p><img width="572" height="197" alt="screenshot" title="screenshot" src="public/suppImage_127.jpg"><p>Here is the EEX flat-processed map, showing the completion message:</p><img width="572" height="787" alt="screenshot" title="screenshot" src="public/suppImage_128.jpg"><p>Here are the console messages from the sequence of steps: Load/raw, Load/border, EEX:</p><p>LoadPropertyFilesAction: file=&quot;D:\Users\kdjang\Velma_SiteData\WA_ThorntonCreek\thornton_mask_v2_10m.asc&quot;
<p>hasData=true ncol=681 nrow=990 xll=548019.221 yll=5281283.0124 isLlCenter=false cell=10.0 ndata=-9999.0 zmin=0.0 zmax=167.9841 delx=0 dely=0 minLogFacc=0.0 maxLogFacc=0.0
<p>LoadDmMaskFileAction: file=&quot;D:\Users\kdjang\Velma_SiteData\WA_ThorntonCreek\thornton_borderMask_v2_10m.asc&quot;
<p>At 2017-05-10 15:02:22: Launching Enhanced Experimental Flat-Processor thread ... Experimental Flat-Processor: processed 622821 cells
<p>Experimental Flat-Processor: largest set processed = 4234 Internal Data State Report
<p>Map Summary: Total Cols=681 Total Rows=990 Total Cells=674190 NoData cells: Actual=0
<p>Buffer Cells: Expected=3338 Actual=51369 Suspect=0 !!! WARNING !!! Interior Cells: Expected=670852 Actual=622821 Suspect=0 !!! WARNING !!! At 2017-05-10 15:02:22: STARTED Enhanced Experimental Flat-Processor At 2017-05-10 15:11:45:  DONE Enhanced Experimental Flat-Processor Elapse Time in seconds = 562.374<p>Some observations:</p><img height="725" alt="screenshot" title="screenshot" src="public/suppImage_129.jpg"></div></body><footer id="footer"><p>VELMA 2.2 DOCUMENTATION</p></footer></html>